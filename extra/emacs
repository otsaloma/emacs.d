#!/bin/sh

# Open files in existing Emacs window or open a new one.
# Usage: emacs [OPTION...] [FILE...]

export GDK_SCALE=emacs
export GTK_THEME=Adwaita:dark
export LC_ALL=C.UTF-8

# Remove stale server if Emacs crashed.
[ -z "$(ps ux | grep "/usr/bin/emac[s]")" ] && rm -rfv /tmp/emacs1000/

if [ -f "$1" ]; then
    # Activate Python virtual environment if found at project root.
    ROOT="$(cd "$(dirname "$1")" && git rev-parse --show-toplevel 2> /dev/null)"
    [ -f "$ROOT/venv/bin/activate" ] && . "$ROOT/venv/bin/activate"
fi

if [ -e /tmp/emacs1000/server ]; then
    # Open files given as arguments in already running server.
    /usr/bin/emacsclient.emacs -n "$@"
else
    # Start a new emacs, open files given as arguments and start the server.
    /usr/bin/emacs -g 90x40 --eval "(server-mode 1)" "$@" &
fi
